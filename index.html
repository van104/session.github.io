<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>精准计时 - 高级倒计时系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- Tailwind 配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            success: '#36D399',
            warning: '#FBBD23',
            danger: '#F87272',
            dark: '#1E293B',
            light: '#F8FAFC'
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
          boxShadow: {
            'elevation-1': '0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24)',
            'elevation-2': '0 3px 6px rgba(0,0,0,0.15), 0 2px 4px rgba(0,0,0,0.12)',
            'elevation-3': '0 10px 20px rgba(0,0,0,0.15), 0 3px 6px rgba(0,0,0,0.10)',
            'elevation-4': '0 15px 25px rgba(0,0,0,0.15), 0 5px 10px rgba(0,0,0,0.05)',
          }
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .text-shadow {
        text-shadow: 0 2px 10px rgba(22, 93, 255, 0.15);
      }
      .text-gradient {
        background-clip: text;
        -webkit-background-clip: text;
        color: transparent;
      }
      .glass-effect {
        backdrop-filter: blur(12px);
        background-color: rgba(255, 255, 255, 0.7);
      }
      .touch-friendly {
        min-height: 60px;
        min-width: 60px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      .pulse-animation {
        animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      .bounce-in {
        animation: bounce-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      .slide-up {
        animation: slide-up 0.4s ease-out forwards;
      }
      .slide-down {
        animation: slide-down 0.4s ease-out forwards;
      }
      .hover-scale {
        transition: transform 0.2s ease;
      }
      .hover-scale:hover {
        transform: scale(1.03);
      }
      /* 新增拖拽相关样式 */
      .dragging {
        opacity: 0.5;
        transform: scale(1.05);
        background-color: rgba(22, 93, 255, 0.2);
      }
      .drag-over {
        border: 2px dashed #165DFF;
      }
      @keyframes pulse {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }
      @keyframes bounce-in {
        0% { transform: scale(0.9); opacity: 0; }
        70% { transform: scale(1.05); }
        100% { transform: scale(1); opacity: 1; }
      }
      @keyframes slide-up {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      @keyframes slide-down {
        from { transform: translateY(-10px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
    }
  </style>
</head>
<body class="font-inter bg-gradient-to-br from-blue-50 to-indigo-50 min-h-screen text-dark antialiased">
  <div class="container mx-auto px-4 py-6 sm:py-8 max-w-4xl">
    <!-- 头部标题 -->
    <header class="text-center mb-6 sm:mb-8 pt-4">
      <h1 class="text-[clamp(1.8rem,8vw,3rem)] font-bold text-gradient bg-gradient-to-r from-primary to-indigo-600 text-shadow bounce-in">精准计时</h1>
      <p class="text-gray-600 mt-2 text-base sm:text-lg opacity-80">高级自定义倒计时系统</p>
    </header>

    <!-- 主要内容区 -->
    <main class="bg-white rounded-2xl shadow-elevation-2 p-4 sm:p-6 md:p-8 mb-6 sm:mb-8 transform transition-all duration-300 hover:shadow-elevation-3">
      <!-- 倒计时显示 -->
      <div class="text-center mb-6 sm:mb-10">
        <div id="timer-display" class="text-[clamp(2.5rem,15vw,5rem)] font-bold text-dark transition-all duration-300 py-4 sm:py-6 bg-gradient-to-r from-gray-800 to-gray-700 text-gradient">
          00:00:00
        </div>
        <div id="timer-label" class="text-primary font-medium mb-2 text-lg sm:text-xl min-h-[2rem]"></div>
        <div id="timer-status" class="text-gray-500 text-base h-6 transition-all duration-300"></div>
      </div>

      <!-- 控制按钮 - 移动端优化：更大触控区域 -->
      <div class="flex justify-center gap-3 sm:gap-6 mb-6 sm:mb-10 flex-wrap">
        <button id="start-btn" class="bg-success hover:bg-success/90 text-white px-5 sm:px-6 py-3 rounded-full text-base sm:text-lg font-medium shadow-lg hover:shadow-elevation-2 transition-all duration-300 flex items-center gap-2 touch-friendly transform hover:-translate-y-1 active:translate-y-0 hover-scale">
          <i class="fa fa-play"></i> 开始
        </button>
        <button id="pause-btn" class="bg-warning hover:bg-warning/90 text-white px-5 sm:px-6 py-3 rounded-full text-base sm:text-lg font-medium shadow-lg hover:shadow-elevation-2 transition-all duration-300 flex items-center gap-2 touch-friendly transform hover:-translate-y-1 active:translate-y-0 hover-scale" disabled>
          <i class="fa fa-pause"></i> 暂停
        </button>
        <button id="reset-btn" class="bg-danger hover:bg-danger/90 text-white px-5 sm:px-6 py-3 rounded-full text-base sm:text-lg font-medium shadow-lg hover:shadow-elevation-2 transition-all duration-300 flex items-center gap-2 touch-friendly transform hover:-translate-y-1 active:translate-y-0 hover-scale" disabled>
          <i class="fa fa-refresh"></i> 重置
        </button>
      </div>

      <!-- 快速设置按钮区域 -->
      <div class="mb-6 sm:mb-10 slide-up">
        <h2 class="text-lg sm:text-xl font-semibold mb-3 sm:mb-4 text-gray-700 flex items-center">
          <i class="fa fa-clock-o text-primary mr-2"></i>快速计时
        </h2>
        <div id="quick-buttons" class="flex flex-wrap gap-3 sm:gap-4 justify-center">
          <!-- 快速按钮将通过JS动态生成 -->
        </div>
      </div>

      <!-- 自定义时间设置（可折叠） -->
      <div class="mb-6 sm:mb-10 slide-up" style="animation-delay: 0.1s">
        <!-- 折叠/展开按钮 -->
        <button id="custom-time-toggle" class="w-full flex items-center justify-center gap-2 text-primary font-medium py-2 transition-all duration-300 touch-friendly hover-scale">
          <i class="fa fa-sliders"></i>
          <span>自定义时间</span>
          <i id="custom-time-icon" class="fa fa-chevron-down transition-transform duration-300 ml-auto"></i>
        </button>
        
        <!-- 自定义时间内容（默认隐藏） -->
        <div id="custom-time-content" class="hidden mt-3 p-3 sm:p-4 bg-gray-50 rounded-xl shadow-sm slide-down">
          <div class="grid grid-cols-3 gap-3">
            <div class="text-center">
              <label for="hours" class="block text-gray-600 mb-1 text-sm">小时</label>
              <input type="number" id="hours" min="0" max="23" value="0" 
                    class="w-full p-2 border border-gray-300 rounded-lg text-center focus:ring-2 focus:ring-primary focus:border-primary transition-all shadow-sm focus:shadow">
            </div>
            <div class="text-center">
              <label for="minutes" class="block text-gray-600 mb-1 text-sm">分钟</label>
              <input type="number" id="minutes" min="0" max="59" value="0" 
                    class="w-full p-2 border border-gray-300 rounded-lg text-center focus:ring-2 focus:ring-primary focus:border-primary transition-all shadow-sm focus:shadow">
            </div>
            <div class="text-center">
              <label for="seconds" class="block text-gray-600 mb-1 text-sm">秒钟</label>
              <input type="number" id="seconds" min="0" max="59" value="10" 
                    class="w-full p-2 border border-gray-300 rounded-lg text-center focus:ring-2 focus:ring-primary focus:border-primary transition-all shadow-sm focus:shadow">
            </div>
          </div>
          <div class="mt-3">
            <label for="custom-label" class="block text-gray-600 mb-1 text-sm">计时标签（可选）</label>
            <input type="text" id="custom-label" placeholder="例如：敷面膜" 
                  class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all shadow-sm focus:shadow">
            <p class="text-xs text-gray-500 mt-1">添加标签可以更好地管理您的计时任务</p>
          </div>
          <div class="mt-3 sm:mt-4 text-center">
            <button id="custom-start-btn" class="bg-primary hover:bg-primary/90 text-white px-5 py-2 rounded-full text-sm sm:text-md font-medium shadow hover:shadow-md transition-all duration-300 touch-friendly hover-scale">
              设置并开始
            </button>
          </div>
        </div>
      </div>

      <!-- 计时小贴士 -->
      <div class="mb-6 sm:mb-10 slide-up" style="animation-delay: 0.15s">
        <div class="bg-gradient-to-r from-primary/5 to-indigo-500/5 p-4 sm:p-5 rounded-xl border border-primary/10">
          <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-2 flex items-center">
            <i class="fa fa-lightbulb-o text-primary mr-2"></i>计时小贴士
          </h3>
          <ul class="text-gray-600 text-sm sm:text-base space-y-2">
            <li class="flex items-start gap-2">
              <i class="fa fa-check-circle text-success mt-1"></i>
              <span>使用标签功能可以更好地管理多个计时任务</span>
            </li>
            <li class="flex items-start gap-2">
              <i class="fa fa-check-circle text-success mt-1"></i>
              <span>常用的计时可以添加到快速按钮，方便下次使用</span>
            </li>
            <li class="flex items-start gap-2">
              <i class="fa fa-check-circle text-success mt-1"></i>
              <span>重要计时可在设置中开启循环提示音，确保不会错过</span>
            </li>
          </ul>
        </div>
      </div>

      <!-- 设置面板切换按钮 -->
      <div class="text-center slide-up" style="animation-delay: 0.2s">
        <button id="settings-toggle" class="text-primary hover:text-primary/80 font-medium flex items-center gap-1 mx-auto transition-all duration-300 touch-friendly px-3 py-2 hover-scale">
          <i class="fa fa-cog"></i> 高级设置
          <i id="settings-icon" class="fa fa-chevron-down transition-transform duration-300"></i>
        </button>
      </div>
    </main>

    <!-- 设置面板 -->
    <div id="settings-panel" class="bg-white rounded-2xl shadow-elevation-2 p-4 sm:p-6 md:p-8 mb-6 sm:mb-8 hidden transform transition-all duration-500 ease-in-out slide-up">
      <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-5 flex items-center">
        <i class="fa fa-sliders text-primary mr-2"></i>高级设置
      </h2>

      <div class="space-y-6 sm:space-y-8">
        <!-- 音频设置 -->
        <div class="p-3 sm:p-4 bg-gray-50 rounded-xl shadow-sm transition-all duration-300 hover:shadow">
          <h3 class="text-base sm:text-xl font-semibold mb-3 sm:mb-4 text-gray-700">提示音设置</h3>
          
          <div class="mb-3 sm:mb-4">
            <label class="block text-gray-600 mb-2">内置提示音</label>
            <div class="grid grid-cols-1 gap-2 sm:grid-cols-2 sm:gap-3">
              <button class="sound-option p-3 border border-gray-300 rounded-lg text-left hover:border-primary hover:bg-primary/5 transition-all flex items-center gap-2 touch-friendly hover-scale" data-sound="default">
                <i class="fa fa-bell-o text-primary"></i>
                <div>
                  <div>默认提示音</div>
                  <div class="text-sm text-gray-500">经典提示音</div>
                </div>
              </button>
              <button class="sound-option p-3 border border-gray-300 rounded-lg text-left hover:border-primary hover:bg-primary/5 transition-all flex items-center gap-2 touch-friendly hover-scale" data-sound="digital">
                <i class="fa fa-bell text-primary"></i>
                <div>
                  <div>数字提示音</div>
                  <div class="text-sm text-gray-500">电子音效</div>
                </div>
              </button>
              <button class="sound-option p-3 border border-gray-300 rounded-lg text-left hover:border-primary hover:bg-primary/5 transition-all flex items-center gap-2 touch-friendly hover-scale" data-sound="soft">
                <i class="fa fa-volume-up text-primary"></i>
                <div>
                  <div>柔和提示音</div>
                  <div class="text-sm text-gray-500">轻柔提示音</div>
                </div>
              </button>
              <button class="sound-option p-3 border border-gray-300 rounded-lg text-left hover:border-primary hover:bg-primary/5 transition-all flex items-center gap-2 touch-friendly hover-scale" data-sound="alarm">
                <i class="fa fa-exclamation-triangle text-primary"></i>
                <div>
                  <div>警报提示音</div>
                  <div class="text-sm text-gray-500">响亮提示音</div>
                </div>
              </button>
            </div>
          </div>
          
          <div class="mb-4">
            <label class="flex items-center">
              <input type="checkbox" id="loop-sound" class="form-checkbox h-5 w-5 text-primary rounded">
              <span class="ml-2 text-gray-700">计时结束后循环播放提示音</span>
            </label>
          </div>

          <div>
            <label class="block text-gray-600 mb-2">上传自定义提示音</label>
            <div class="flex flex-col sm:flex-row items-center gap-3">
              <label for="custom-sound" class="flex-1 border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-primary hover:bg-primary/5 transition-all cursor-pointer touch-friendly hover-scale">
                <input type="file" id="custom-sound" accept="audio/*" class="hidden">
                <i class="fa fa-upload text-gray-400 text-xl mb-1"></i>
                <div class="text-gray-500 text-sm" id="custom-sound-name">点击上传音频文件</div>
              </label>
              <button id="preview-sound" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg transition-all touch-friendly hover-scale">
                <i class="fa fa-play"></i> 预览
              </button>
            </div>
            <p class="text-sm text-gray-500 mt-2">支持 MP3, WAV, OGG 格式</p>
          </div>
        </div>

        <!-- 快速按钮管理 -->
        <div class="p-3 sm:p-4 bg-gray-50 rounded-xl shadow-sm transition-all duration-300 hover:shadow">
          <h3 class="text-base sm:text-xl font-semibold mb-3 sm:mb-4 text-gray-700">快速按钮管理</h3>
          
          <div class="mb-5">
            <h4 class="font-medium text-gray-600 mb-2">添加新的快速按钮</h4>
            <div class="grid grid-cols-3 gap-2 mb-3">
              <div>
                <label class="block text-gray-500 text-xs sm:text-sm mb-1">小时</label>
                <input type="number" id="new-hour" min="0" max="23" value="0" 
                      class="w-full p-2 border border-gray-300 rounded-lg text-center text-sm shadow-sm focus:shadow">
              </div>
              <div>
                <label class="block text-gray-500 text-xs sm:text-sm mb-1">分钟</label>
                <input type="number" id="new-minute" min="0" max="59" value="5" 
                      class="w-full p-2 border border-gray-300 rounded-lg text-center text-sm shadow-sm focus:shadow">
              </div>
              <div>
                <label class="block text-gray-500 text-xs sm:text-sm mb-1">秒钟</label>
                <input type="number" id="new-second" min="0" max="59" value="0" 
                      class="w-full p-2 border border-gray-300 rounded-lg text-center text-sm shadow-sm focus:shadow">
              </div>
            </div>
            <div class="mb-3">
              <label class="block text-gray-500 text-xs sm:text-sm mb-1">标签（可选）</label>
              <input type="text" id="new-label" placeholder="例如：休息" 
                    class="w-full p-2 border border-gray-300 rounded-lg text-sm shadow-sm focus:shadow">
              <p class="text-xs text-gray-500 mt-1">标签会显示在按钮上方，时间显示在下方</p>
            </div>
            <button id="add-quick-btn" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg text-sm transition-all touch-friendly hover-scale">
              <i class="fa fa-plus"></i> 添加快速按钮
            </button>
          </div>

          <div>
            <h4 class="font-medium text-gray-600 mb-2">编辑或删除现有按钮</h4>
            <div id="editable-quick-buttons" class="flex flex-wrap gap-2 sm:gap-3">
              <!-- 可编辑的快速按钮将通过JS动态生成 -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 页脚 -->
    <footer class="text-center text-gray-500 text-xs sm:text-sm py-3 opacity-80">
      <p>© 2025 精准计时系统 | 一个功能强大的在线倒计时工具</p>
    </footer>
  </div>

  <!-- 音频元素 -->
  <audio id="timer-sound" preload="auto" loop></audio>

  <script>
    // 全局变量
    let timer = null;
    let totalSeconds = 0;
    let remainingSeconds = 0;
    let isRunning = false;
    let currentSound = 'default';
    let customSoundUrl = null;
    let loopSound = false;
    let currentLabel = '';
    // 新增拖拽相关变量
    let draggedItemIndex = -1;
    
    // 内置音效
    const sounds = {
      default: 'https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3',
      digital: 'https://assets.mixkit.co/sfx/preview/mixkit-digital-clock-digital-alarm-bell-989.mp3',
      soft: 'https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3',
      alarm: 'https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3'
    };

    // 快速按钮默认时间（秒）和标签
    let quickTimes = [
      {time: 60, label: '1分钟'},      // 1分钟
      {time: 300, label: '5分钟'},     // 5分钟
      {time: 600, label: '10分钟'},    // 10分钟
      {time: 1800, label: '30分钟'},   // 30分钟
      {time: 3600, label: '1小时'},    // 1小时
      {time: 900, label: '15分钟'}     // 15分钟
    ];

    // DOM元素
    const timerDisplay = document.getElementById('timer-display');
    const timerLabel = document.getElementById('timer-label');
    const timerStatus = document.getElementById('timer-status');
    const startBtn = document.getElementById('start-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const resetBtn = document.getElementById('reset-btn');
    const customStartBtn = document.getElementById('custom-start-btn');
    const hoursInput = document.getElementById('hours');
    const minutesInput = document.getElementById('minutes');
    const secondsInput = document.getElementById('seconds');
    const customLabelInput = document.getElementById('custom-label');
    const quickButtonsContainer = document.getElementById('quick-buttons');
    const editableQuickButtonsContainer = document.getElementById('editable-quick-buttons');
    const settingsToggle = document.getElementById('settings-toggle');
    const settingsPanel = document.getElementById('settings-panel');
    const settingsIcon = document.getElementById('settings-icon');
    const soundOptions = document.querySelectorAll('.sound-option');
    const loopSoundCheckbox = document.getElementById('loop-sound');
    const customSoundInput = document.getElementById('custom-sound');
    const customSoundName = document.getElementById('custom-sound-name');
    const previewSoundBtn = document.getElementById('preview-sound');
    const addQuickBtn = document.getElementById('add-quick-btn');
    const newHourInput = document.getElementById('new-hour');
    const newMinuteInput = document.getElementById('new-minute');
    const newSecondInput = document.getElementById('new-second');
    const newLabelInput = document.getElementById('new-label');
    const customTimeToggle = document.getElementById('custom-time-toggle');
    const customTimeContent = document.getElementById('custom-time-content');
    const customTimeIcon = document.getElementById('custom-time-icon');
    const timerSound = document.getElementById('timer-sound');

    // 初始化
    function init() {
      // 按时间从小到大排序
      quickTimes.sort((a, b) => a.time - b.time);
      
      // 从本地存储加载数据
      loadFromLocalStorage();
      
      // 渲染快速按钮
      renderQuickButtons();
      updateEditableQuickButtons();
      
      // 设置事件监听器
      setupEventListeners();
      
      // 设置默认音效
      setSound(currentSound);
    }

    // 格式化时间显示
    function formatTime(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      return [
        h.toString().padStart(2, '0'),
        m.toString().padStart(2, '0'),
        s.toString().padStart(2, '0')
      ].join(':');
    }

    // 开始计时器
    function startTimer(seconds, label = '') {
      if (timer) clearInterval(timer);
      
      totalSeconds = seconds;
      remainingSeconds = seconds;
      currentLabel = label;
      
      updateTimerDisplay();
      timerLabel.textContent = label || '计时中...';
      timerStatus.textContent = '进行中';
      timerStatus.classList.add('text-primary');
      
      isRunning = true;
      updateButtonStates();
      
      timer = setInterval(() => {
        remainingSeconds--;
        
        if (remainingSeconds <= 0) {
          completeTimer();
          return;
        }
        
        updateTimerDisplay();
      }, 1000);
    }

    // 暂停计时器
    function pauseTimer() {
      if (timer) {
        clearInterval(timer);
        timer = null;
        isRunning = false;
        timerStatus.textContent = '已暂停';
        timerStatus.classList.remove('text-primary');
        timerStatus.classList.add('text-warning');
        updateButtonStates();
      }
    }

    // 重置计时器
    function resetTimer() {
      if (timer) {
        clearInterval(timer);
        timer = null;
      }
      
      isRunning = false;
      remainingSeconds = 0;
      totalSeconds = 0;
      currentLabel = '';
      
      updateTimerDisplay();
      timerLabel.textContent = '';
      timerStatus.textContent = '未开始';
      timerStatus.classList.remove('text-primary', 'text-warning', 'text-success', 'text-danger');
      
      updateButtonStates();
      
      // 停止音效
      timerSound.pause();
      timerSound.currentTime = 0;
    }

    // 完成计时
    function completeTimer() {
      clearInterval(timer);
      timer = null;
      isRunning = false;
      
      remainingSeconds = 0;
      updateTimerDisplay();
      timerStatus.textContent = '已完成';
      timerStatus.classList.remove('text-primary', 'text-warning');
      timerStatus.classList.add('text-success');
      
      updateButtonStates();
      
      // 播放提示音
      playTimerSound();
    }

    // 更新计时器显示
    function updateTimerDisplay() {
      timerDisplay.textContent = formatTime(remainingSeconds);
      
      // 添加视觉反馈：最后10秒变红并闪烁
      if (remainingSeconds <= 10 && remainingSeconds > 0) {
        timerDisplay.classList.add('text-danger', 'pulse-animation');
      } else {
        timerDisplay.classList.remove('text-danger', 'pulse-animation');
      }
    }

    // 更新按钮状态
    function updateButtonStates() {
      startBtn.disabled = isRunning;
      pauseBtn.disabled = !isRunning;
      resetBtn.disabled = totalSeconds === 0 || (remainingSeconds === totalSeconds && !isRunning);
    }

    // 设置音效
    function setSound(sound) {
      currentSound = sound;
      timerSound.src = sounds[sound];
      timerSound.loop = loopSound;
      
      // 更新选中状态
      soundOptions.forEach(option => {
        if (option.dataset.sound === sound) {
          option.classList.add('border-primary', 'bg-primary/5');
        } else {
          option.classList.remove('border-primary', 'bg-primary/5');
        }
      });
    }

    // 播放计时结束提示音
    function playTimerSound() {
      timerSound.currentTime = 0;
      timerSound.loop = loopSound;
      timerSound.play().catch(e => {
        console.log('无法自动播放音效:', e);
        // 可以在这里添加一个提示，让用户交互后再播放
      });
    }

    // 渲染快速按钮
    function renderQuickButtons() {
      quickButtonsContainer.innerHTML = '';
      
      quickTimes.forEach((item, index) => {
        const buttonData = {
          time: typeof item.time === 'number' && item.time > 0 ? item.time : 60,
          label: typeof item.label === 'string' ? item.label : ''
        };
        
        const btn = document.createElement('button');
        btn.className = 'bg-primary/10 hover:bg-primary/20 text-primary rounded-lg font-medium transition-all duration-300 transform hover:-translate-y-1 active:translate-y-0 touch-friendly hover-scale whitespace-nowrap py-2';
        
        // 添加拖拽属性
        btn.draggable = true;
        btn.dataset.index = index;
        
        // 时间格式化
        const timeText = formatTime(buttonData.time);
        
        // 显示文本
        let displayText = timeText;
        if (buttonData.label && buttonData.label.trim()) {
          displayText = `${buttonData.label}\n${timeText}`;
        }
        
        btn.textContent = displayText;
        btn.style.whiteSpace = 'pre-line';
        btn.style.lineHeight = '1.2';
        
        btn.addEventListener('click', () => {
          btn.classList.add('bounce-in');
          setTimeout(() => btn.classList.remove('bounce-in'), 500);
          startTimer(buttonData.time, buttonData.label);
        });
        
        // 添加拖拽事件监听
        btn.addEventListener('dragstart', handleDragStart);
        btn.addEventListener('dragover', handleDragOver);
        btn.addEventListener('dragenter', handleDragEnter);
        btn.addEventListener('dragleave', handleDragLeave);
        btn.addEventListener('drop', handleDrop);
        btn.addEventListener('dragend', handleDragEnd);
        
        quickButtonsContainer.appendChild(btn);
      });
      
      adjustQuickButtonsForMobile();
    }

    // 调整快速按钮在移动设备上的显示
    function adjustQuickButtonsForMobile() {
      if (window.innerWidth < 640) {
        const buttons = quickButtonsContainer.querySelectorAll('button');
        buttons.forEach(btn => {
          btn.style.minWidth = '80px';
          btn.style.padding = '8px 4px';
        });
      }
    }

    // 更新可编辑的快速按钮
    function updateEditableQuickButtons() {
      editableQuickButtonsContainer.innerHTML = '';
      
      quickTimes.forEach((item, index) => {
        const validTime = typeof item.time === 'number' && item.time > 0 ? item.time : 60;
        
        const container = document.createElement('div');
        container.className = 'flex items-center gap-2 bg-white p-2 rounded-lg border border-gray-200 hover:border-primary/50 transition-all duration-300 hover-scale';
        
        // 添加拖拽属性
        container.draggable = true;
        container.dataset.index = index;
        
        const timeDisplay = document.createElement('span');
        timeDisplay.className = 'text-gray-700 min-w-[80px]';
        timeDisplay.textContent = formatTime(validTime);
        
        const labelDisplay = document.createElement('span');
        labelDisplay.className = 'text-primary text-xs hidden sm:inline-block';
        labelDisplay.textContent = item.label ? `(${item.label})` : '';
        
        const editBtn = document.createElement('button');
        editBtn.className = 'text-primary hover:text-primary/80 p-2 touch-friendly transition-colors';
        editBtn.innerHTML = '<i class="fa fa-pencil"></i>';
        editBtn.title = '编辑';
        editBtn.addEventListener('click', () => editQuickTime(index));
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'text-danger hover:text-danger/80 p-2 touch-friendly transition-colors';
        deleteBtn.innerHTML = '<i class="fa fa-trash"></i>';
        deleteBtn.title = '删除';
        deleteBtn.addEventListener('click', () => deleteQuickTime(index));
        
        container.appendChild(timeDisplay);
        container.appendChild(labelDisplay);
        container.appendChild(editBtn);
        container.appendChild(deleteBtn);
        
        // 添加拖拽事件监听
        container.addEventListener('dragstart', handleDragStart);
        container.addEventListener('dragover', handleDragOver);
        container.addEventListener('dragenter', handleDragEnter);
        container.addEventListener('dragleave', handleDragLeave);
        container.addEventListener('drop', handleDrop);
        container.addEventListener('dragend', handleDragEnd);
        
        editableQuickButtonsContainer.appendChild(container);
      });
    }

    // 编辑快速按钮
    function editQuickTime(index) {
      if (index >= 0 && index < quickTimes.length) {
        const item = quickTimes[index];
        const totalSeconds = item.time || 0;
        
        // 填充表单
        newHourInput.value = Math.floor(totalSeconds / 3600);
        newMinuteInput.value = Math.floor((totalSeconds % 3600) / 60);
        newSecondInput.value = totalSeconds % 60;
        newLabelInput.value = item.label || '';
        
        // 删除原按钮
        deleteQuickTime(index);
        
        // 滚动到添加按钮位置
        addQuickBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    // 删除快速按钮
    function deleteQuickTime(index) {
      if (index >= 0 && index < quickTimes.length) {
        quickTimes.splice(index, 1);
        renderQuickButtons();
        updateEditableQuickButtons();
        saveToLocalStorage();
        
        // 显示删除提示
        showNotification('快速按钮已删除', 'danger');
      }
    }

    // 添加快速按钮
    function addQuickTime() {
      const hours = parseInt(newHourInput.value) || 0;
      const minutes = parseInt(newMinuteInput.value) || 0;
      const seconds = parseInt(newSecondInput.value) || 0;
      const label = newLabelInput.value.trim();
      
      const totalSeconds = hours * 3600 + minutes * 60 + seconds;
      
      if (totalSeconds > 0) {
        quickTimes.push({
          time: totalSeconds,
          label: label
        });
        
        // 清空输入
        newHourInput.value = 0;
        newMinuteInput.value = 5;
        newSecondInput.value = 0;
        newLabelInput.value = '';
        
        // 重新渲染
        renderQuickButtons();
        updateEditableQuickButtons();
        saveToLocalStorage();
        
        // 显示成功提示
        showNotification('快速按钮已添加', 'success');
      } else {
        // 显示错误提示
        const inputs = [newHourInput, newMinuteInput, newSecondInput];
        inputs.forEach(input => {
          input.classList.add('border-danger');
          setTimeout(() => input.classList.remove('border-danger'), 1000);
        });
        showNotification('时间必须大于0', 'danger');
      }
    }

    // 显示通知
    function showNotification(message, type = 'primary') {
      const status = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-success' : 
                     type === 'danger' ? 'bg-danger' : 'bg-primary';
      
      status.className = `fixed top-4 right-4 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50 bounce-in`;
      status.textContent = message;
      document.body.appendChild(status);
      
      setTimeout(() => {
        status.classList.add('slide-down');
        status.style.opacity = '0';
        setTimeout(() => status.remove(), 500);
      }, 2000);
    }

    // 保存数据到本地存储
    function saveToLocalStorage() {
      try {
        localStorage.setItem('quickTimes', JSON.stringify(quickTimes));
        localStorage.setItem('currentSound', currentSound);
        localStorage.setItem('loopSound', loopSound);
        if (customSoundUrl) {
          localStorage.setItem('customSoundUrl', customSoundUrl);
        }
      } catch (e) {
        console.error('保存到本地存储失败:', e);
      }
    }

    // 从本地存储加载数据
    function loadFromLocalStorage() {
      try {
        const savedQuickTimes = localStorage.getItem('quickTimes');
        const savedSound = localStorage.getItem('currentSound');
        const savedLoopSound = localStorage.getItem('loopSound');
        const savedCustomSound = localStorage.getItem('customSoundUrl');
        
        if (savedQuickTimes) {
          quickTimes = JSON.parse(savedQuickTimes);
        }
        
        if (savedSound && sounds[savedSound]) {
          currentSound = savedSound;
        }
        
        if (savedLoopSound) {
          loopSound = savedLoopSound === 'true';
          loopSoundCheckbox.checked = loopSound;
        }
        
        if (savedCustomSound) {
          customSoundUrl = savedCustomSound;
          customSoundName.textContent = '已上传自定义音效';
        }
      } catch (e) {
        console.error('从本地存储加载失败:', e);
      }
    }

    // 设置事件监听器
    function setupEventListeners() {
      // 计时器控制
      startBtn.addEventListener('click', () => {
        const hours = parseInt(hoursInput.value) || 0;
        const minutes = parseInt(minutesInput.value) || 0;
        const seconds = parseInt(secondsInput.value) || 0;
        const label = customLabelInput.value.trim();
        
        const totalSeconds = hours * 3600 + minutes * 60 + seconds;
        
        if (totalSeconds > 0) {
          startTimer(totalSeconds, label);
        } else {
          // 显示错误提示
          const inputs = [hoursInput, minutesInput, secondsInput];
          inputs.forEach(input => {
            input.classList.add('border-danger');
            setTimeout(() => input.classList.remove('border-danger'), 1000);
          });
        }
      });
      
      pauseBtn.addEventListener('click', pauseTimer);
      resetBtn.addEventListener('click', resetTimer);
      
      // 自定义时间切换
      customTimeToggle.addEventListener('click', () => {
        customTimeContent.classList.toggle('hidden');
        customTimeIcon.classList.toggle('rotate-180');
      });
      
      // 自定义开始按钮
      customStartBtn.addEventListener('click', () => {
        const hours = parseInt(hoursInput.value) || 0;
        const minutes = parseInt(minutesInput.value) || 0;
        const seconds = parseInt(secondsInput.value) || 0;
        const label = customLabelInput.value.trim();
        
        const totalSeconds = hours * 3600 + minutes * 60 + seconds;
        
        if (totalSeconds > 0) {
          startTimer(totalSeconds, label);
        } else {
          // 显示错误提示
          const inputs = [hoursInput, minutesInput, secondsInput];
          inputs.forEach(input => {
            input.classList.add('border-danger');
            setTimeout(() => input.classList.remove('border-danger'), 1000);
          });
        }
      });
      
      // 设置面板切换
      settingsToggle.addEventListener('click', () => {
        settingsPanel.classList.toggle('hidden');
        settingsIcon.classList.toggle('rotate-180');
      });
      
      // 音效选择
      soundOptions.forEach(option => {
        option.addEventListener('click', () => {
          setSound(option.dataset.sound);
          saveToLocalStorage();
        });
      });
      
      // 循环音效
      loopSoundCheckbox.addEventListener('change', () => {
        loopSound = loopSoundCheckbox.checked;
        timerSound.loop = loopSound;
        saveToLocalStorage();
      });
      
      // 自定义音效上传
      customSoundInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files[0]) {
          const file = e.target.files[0];
          if (file.type.indexOf('audio/') === 0) {
            const reader = new FileReader();
            reader.onload = (event) => {
              customSoundUrl = event.target.result;
              timerSound.src = customSoundUrl;
              currentSound = 'custom';
              customSoundName.textContent = file.name;
              
              // 更新选中状态
              soundOptions.forEach(option => {
                option.classList.remove('border-primary', 'bg-primary/5');
              });
              
              saveToLocalStorage();
              showNotification('自定义音效已上传', 'success');
            };
            reader.readAsDataURL(file);
          } else {
            showNotification('请上传音频文件', 'danger');
          }
        }
      });
      
      // 预览音效
      previewSoundBtn.addEventListener('click', () => {
        if (currentSound === 'custom' && customSoundUrl) {
          timerSound.src = customSoundUrl;
        } else {
          timerSound.src = sounds[currentSound];
        }
        timerSound.currentTime = 0;
        timerSound.loop = false;
        timerSound.play().catch(e => {
          console.log('无法播放音效:', e);
          showNotification('请先交互页面再尝试播放音效', 'warning');
        });
      });
      
      // 添加快速按钮
      addQuickBtn.addEventListener('click', addQuickTime);
      
      // 窗口大小变化时调整按钮
      window.addEventListener('resize', adjustQuickButtonsForMobile);
    }

    // 拖拽相关事件处理函数
    function handleDragStart(e) {
      draggedItemIndex = parseInt(this.dataset.index);
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragOver(e) {
      if (e.preventDefault) {
        e.preventDefault(); // 允许放置
      }
      e.dataTransfer.dropEffect = 'move';
      return false;
    }

    function handleDragEnter(e) {
      this.classList.add('drag-over');
    }

    function handleDragLeave() {
      this.classList.remove('drag-over');
    }

    function handleDrop(e) {
      e.stopPropagation(); // 阻止事件冒泡
      
      if (draggedItemIndex !== -1) {
        const dropIndex = parseInt(this.dataset.index);
        
        // 只有当拖拽的不是同一个元素时才执行交换
        if (draggedItemIndex !== dropIndex) {
          // 交换数组元素
          const temp = quickTimes[draggedItemIndex];
          quickTimes[draggedItemIndex] = quickTimes[dropIndex];
          quickTimes[dropIndex] = temp;
          
          // 重新渲染按钮并保存
          renderQuickButtons();
          updateEditableQuickButtons();
          saveToLocalStorage();
        }
      }
      
      this.classList.remove('drag-over');
      return false;
    }

    function handleDragEnd() {
      // 移除所有拖拽相关的样式
      document.querySelectorAll('.dragging').forEach(el => {
        el.classList.remove('dragging');
      });
      document.querySelectorAll('.drag-over').forEach(el => {
        el.classList.remove('drag-over');
      });
      draggedItemIndex = -1;
    }

    // 初始化应用
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
